name: Cookiecutter CI

on:
  push:
    branches:
      - "main"
  pull_request:
    branches:
      - "main"
  schedule:
    # weekly tests
    - cron: "0 0 * * 0"

# Custom global env block (Has to be recreated in each matrix, can't pass sequences to this)
env:  # I want to share these between jobs, but I can't access the env from inside matrix, has to be on the steps.
  licenses: "1 2"
  depend-sources: "1 2 3"
  rtd: "1 2"

defaults:
  run:
    shell: bash

jobs:
  generate-cookiecutter:
    name: "Cookiecutter Artifacts"
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        # os: [ubuntu-latest, macOS-latest, windows-latest]
        os: [ubuntu-latest]
        python-version: ["3.8", "3.9", "3.10"]
        dependency_source:
          - key: 1
            value: "Prefer conda-forge over the default anaconda channel with pip fallback"
            name: "conda-forge"
          - key: 2
            value: "Prefer default anaconda channel with pip fallback"
            name: "anaconda"
          - key: 3
            value: "Dependencies from pip only (no conda)"
            name: "pip"
        rtd:
          - key: 1
            value: "y"
          - key: 2
            value: "n"
    env:
      TEST_REPO_NAME: "testmdakit_deps-${{ matrix.dependency_source['name'] }}_rtd-${{ matrix.rtd['value'] }}"
      ACTION_DIR: ".github/actions/${TEST_REPO_NAME}"


    steps:
      - uses: actions/checkout@v3

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v3
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install -U cookiecutter

      - name: Construct cookiecutter
        run: |
          cookiecutter --verbose --output-dir ${TEST_REPO_NAME} --no-input . \
            project_name=$TEST_REPO_NAME \
            repo_name=proto-cookiecutter-mda \
            github_username=github-actions-ci \
            github_host_account=lilyminium \
            author_name="Github Actions CI" \
            author_email="github-action@users.noreply.github.com" \
            description="Test MDAKit repository: deps=${{ matrix.dependency_source }}, rtd=${{ matrix.rtd }}" \
            dependency_source="${{ matrix.dependency_source['value'] }}" \
            include_ReadTheDocs="${{ matrix.rtd['value'] }}"
          
          mkdir -p $ACTION_DIR
          cp ${TEST_REPO_NAME}/.github/workflows/CI.yaml ${ACTION_DIR}/action.yaml
          cp ${ACTION_DIR}/action.yaml ./github/actions/

        
      - name: Run cookiecutter CI
        uses: "./github/actions"
        


